---
title: "REMIND-PyPSA-Eur Validation"
author: "Adrian Odenweller, Johannes Hampp"
date: "`r format(Sys.Date())`"
output:
  pdf_document:
    number_sections: true
#    fig_width: 10.7  # Full width of A4 paper
#    fig_height: 7.5  # Full height of A4 paper
    extra_dependencies: ["float"]
fontsize: 11pt
geometry: "a4paper,landscape,left=0.5cm,right=0.5cm,top=0.5cm,bottom=0.5cm,footnotesep=0.0cm,footskip=0.1cm"
documentclass: article
classoption: a4paper, landscape
---

This RMarkdown file contains various plots for validation of the REIMND-PyPSA-Eur model coupling.

```{r setup, include=FALSE}
# Load libraries
library(gdx)
library(tidyverse)
library(stringr)
library(ggpp)
library(quitte)
library(cowplot)

knitr::opts_chunk$set(
  dpi = 300,
  echo = FALSE,
  message = FALSE,
  cache = TRUE,
  fig.pos = "H",
  out.extra = "",
  fig.width = 16,
  fig.height = 12)

theme_set(theme_minimal_hgrid(10))

# Color mapping
colorsTech <- c(
  "solar" = "#ffcc00",
  "onwind" = "#337fff",
  "all_offwind" = "#334cff",
  "offwind" = "#334cff",
  "biomass" = "#005900",
  "ror" = "#191999",
  "CCGT" = "#999959",
  "OCGT" = "#e5e5b2",
  "oil" = "#663a00",
  "all_coal" = "#0c0c0c",
  "coal" = "#0c0c0c",
  "lignite" = "#392306",
  "nuclear" = "#ff33ff"
  )

# Pretty names
namesTech <- c(
  "solar" = "Solar",
  "onwind" = "Wind Onshore",
  "all_offwind" = "Wind Offshore",
  "offwind" = "Wind Offshore",
  "biomass" = "Biomass",
  "ror" = "Run of river",
  "CCGT" = "CCGT",
  "OCGT" = "OCGT",
  "oil" = "Oil",
  "all_coal" = "Coal+Lignite",
  "coal" = "Coal",
  "lignite" = "Lignite",
  "nuclear" = "Nuclear")

# Technology mapping: REMIND to General
rm2genTech <- c(
  "biochp" = "biomass",
  "bioigcc" = "biomass",
  "bioigccc" = "biomass",
  "ngcc" = "CCGT",
  "ngccc" = "CCGT",
  "gaschp" = "CCGT",
  "igcc" = "all_coal",
  "igccc" = "all_coal",
  "pc" = "all_coal",
  "coalchp" = "all_coal",
  "tnrs" = "nuclear",
  "fnrs" = "nuclear",
  "ngt" =  "OCGT",
  "windoff" = "all_offwind",  # Or just offwind?
  "dot" = "oil",
  "wind" = "onwind",
  "hydro" = "ror",
  "spv" = "solar"
  )

# Technology mapping: General to REMIND
gen2rmTech <- c(
  "biomass" = "biomass",
  "CCGT" = "CCGT",
  "coal" = "all_coal",  # Aggregate coal
  "lignite" = "all_coal",  # Aggregate coal
  "nuclear" = "nuclear",
  "OCGT" = "OCGT",
  "offwind-ac" = "all_offwind",  # Aggregate offshore wind
  "offwind-dc" = "all_offwind",  # Aggregate offshore wind
  "oil" = "oil",
  "onwind" = "onwind",
  "ror" = "ror",
  "solar" = "solar"
)

# PyPSA-Eur pretty names to generalised names
py2genTech <- c(
  "Biomass" = "biomass",
  "Coal" = "all_coal",
  "Combined-Cycle Gas" = "CCGT",
  "Lignite" = "all_coal",
  "Nuclear" = "nuclear",
  "Offshore Wind (DC)" = "all_offwind",
  "Offshore Wind (AC)" = "all_offwind",
  "Oil" = "oil",
  "Onshore Wind" = "onwind",
  "Open-Cycle Gas" = "OCGT",
  "Run of River" = "ror",
  "Solar" = "solar"
)

# ToDo: Get rid of this and switch to the PyPSA general mapping
pygen2genTech <- c(
  "biomass" = "biomass",
  "all_coal" = "all_coal",
  "CCGT" = "CCGT",
  "OCGT" = "OCGT",
  "nuclear" = "nuclear",
  "wind_offshore" = "all_offwind",
  "wind_onshore" = "onwind",
  "oil" = "oil",
  "hydro" = "ror",
  "solar_pv" = "solar"
)

# Years to plot
years <- c(seq(2025, 2060, 5), seq(2070, 2110, 10), 2130, 2150)

# Regions to plot
regions <- "DEU"

# Unit conversions
twa2twh <- 8760
twa2mwh <- 8760 * 1e6
tC2tCO2 <- 44 / 12

```

# Get REMIND and PyPSA-Eur files

```{r data}

# REMIND directories
rmOutdir <- getwd()
scenario <- basename(rmOutdir)  # Scenario name
# REMIND fulldata.gdx files
rmFulldataFiles <- list.files(
  rmOutdir,
  pattern = "((fulldata_)|(non_optimal_))\\d{1,}.gdx",
  full.names = TRUE)
# REMIND2PyPSAEUR.gdx files
rm2pyFiles <- list.files(
  rmOutdir,
  pattern = "REMIND2PyPSAEUR_\\d{1,}.gdx",
  full.names = TRUE)
# PyPSAEUR2REMIND.gdx files
py2rmFiles <- list.files(
  rmOutdir,
  pattern = "PyPSAEUR2REMIND_\\d{1,}.gdx",
  full.names = TRUE
)

# Get iterations from rmFullDataFiles
rmIterations <- as.numeric(gsub(".*_([0-9]+)\\.gdx", "\\1", rmFulldataFiles))

# PyPSA directories
load("config.Rdata")
pyDir <- cfg$gms$c32_pypsa_dir  # Get PyPSA-Eur directory from config.Rdata
pyResourcesDir <- file.path(pyDir, "resources", scenario)
pyResultsDir <- file.path(pyDir, "results", scenario)
# Get subdirectories labeled "i" for iteration followed by an integer number
pyResultsDirs <- list.dirs(pyResultsDir,
                           recursive = FALSE,
                           full.names = TRUE)
pyValidationDirs <- list.dirs(pyResultsDirs,
                              recursive = FALSE,
                              full.names = TRUE)
# Only use "validation" directories
pyValidationDirs <- pyValidationDirs[grep("validation", pyValidationDirs)]
pyResourcesDirs <- list.dirs(pyResourcesDir,
                            recursive = FALSE,
                            full.names = TRUE)
# Add "/" to end of directory names
pyResourcesDirs <- paste0(pyResourcesDirs, "/")

# Some logging
cat(paste("Found", length(rmFulldataFiles), "REMIND fulldata_i.gdx or non_optimal_i.gdx files.\n"))
cat(paste("Found", length(rm2pyFiles), "REMIND2PyPSAEUR_i.gdx files.\n"))
cat(paste("Found", length(pyResultsDirs), "PyPSA-EUR results directories.\n"))
cat(paste("Found", length(pyValidationDirs), "PyPSA-EUR validation directories.\n"))
cat(paste("Found", length(pyResourcesDirs), "PyPSA-EUR resources directories.\n"))
cat(paste("Found", length(py2rmFiles), "PyPSAEUR2REMIND_i.gdx files.\n"))

# Throw warning if number of files does not match
if (length(unique(c(
  length(rmFulldataFiles),
  length(rm2pyFiles),
  length(pyResultsDirs),
  length(pyValidationDirs),
  length(pyResourcesDirs),
  length(py2rmFiles)))) != 1) {
  warning("Number of REMIND files and PyPSA-Eur directories does not match.\n")
}

# Throw warning if rmFullDataFiles contains at least one "non_optimal_i.gdx" file and give number of files
if (length(grep("non_optimal", rmFulldataFiles)) > 0) {
  warning(paste("Found", length(grep("non_optimal", rmFulldataFiles)), "non_optimal_i.gdx REMIND output files.\n"))
}

```

```{r helpers, include = FALSE, echo = FALSE}

# This function reads in csv files in the PyPSA-Eur directory
# Expected path: <PyPSA-Eur results folder>/i<iteration>/<some file>.csv
readPyPSAcsv <- function(paths) {
  purrr::map_df(paths, ~{
    # Extract iteration from path
    iteration <- as.integer(str_extract(.x, "(?<=i)\\d{1,}(?=/)"))
    # Try to read csv file
    tryCatch(
      {
        read.csv(.x, header = TRUE) %>%
          as_tibble() %>%
          mutate(iteration = iteration)
      },
      error = function(e) {
        cat("Error reading file:", .x, "\n")
        tibble() # Return an empty tibble in case of an error
      }
    )
  })
}

# This function reads in gdx files into tibbles
# rmFile: Path to gdx file
# gdxVar: Name of gdx variable to read
# columns: Named *vector* of columns to select and rename
# colFilter: *List* of renamed columns and values to filter for
readGDX <- function(rmFile, gdxVar, columns, colFilter,
                    restoreZeros = TRUE, field = "l", recalcUnit = 1) {
  # Read gdx file
  data <- gdx::readGDX(rmFile, gdxVar, restore_zeros = restoreZeros, field = field) %>%
    as_tibble(.name_repair = "unique")
  # If data is empty create tibble with columns from colFilter and column "value" filled with 0
  if (nrow(data) == 0) {
    data <- tibble(expand.grid(colFilter), value = 0)
  } else {
     data <- data %>% 
      # Select desired columns and rename
      select_at(names(columns), ~ columns) %>%
      # Filter columns according to colFilter
      filter(if_all(names(colFilter), ~ . %in% colFilter$.)) %>% 
      # Multiply by recalcUnit
      mutate(across(columns["value"][[1]], ~ . * recalcUnit))
  }
  return(data)
}

# This function reads in multiple gdx files from REMIND
readREMINDgdx <- function(paths, gdxVar, columns, colFilter,
                          restoreZeros = TRUE, field = "l", recalcUnit = 1) {
  purrr::map_df(paths, ~{
    # Extract iteration from path.
    # Files may be named "fulldata_<iteration>.gdx" or
    # "non_optimal_<iteration>.gdx" or "REMIND2PyPSAEUR_<iteration>.gdx"
    iteration <- as.integer(str_extract(.x, "((?<=fulldata_)|(?<=non_optimal_)|(?<=REMIND2PyPSAEUR_))\\d{1,}(?=.gdx)"))
    readGDX(.x, gdxVar, columns, colFilter, restoreZeros, field, recalcUnit) %>%
      mutate(iteration = iteration)
  })
}

```

# General model information

## Runtime PyPSA-EUR

Runtime for PyPSA-EUR required for each iteration from start of first job to end of last job, based on the change time of the "co2_price_scenarios.csv" and "PyPSAEUR2REMIND.gdx" files.

```{r runtime}

# Get last change time and creation time of "co2_price_scenarios.csv" and "PyPSAEUR2REMIND.gdx" in each directory
fileTimes <- lapply(pyResultsDirs, function(dir) {
  co2PriceFile <- file.path(dir, "co2_price_scenarios.csv")
  couplingFile <- file.path(dir, "PyPSAEUR2REMIND.gdx")
  co2PriceCtime <- file.info(co2PriceFile)$ctime
  couplingCtime <- file.info(couplingFile)$ctime
  timeDiff <- difftime(couplingCtime, co2PriceCtime, units = "mins")
  iteration <- gsub("i", "", basename(dir))
  return(list(directory = dir, iteration = iteration, co2_price_last_change_time = co2PriceCtime, coupling_creation_time = couplingCtime, time_diff = timeDiff))
})

# Combine results into a data frame
fileTimes <- do.call(rbind.data.frame, fileTimes)

# Plot the time difference for each iteration as a bar plot
pTimeDiff <- ggplot() +
  geom_bar(data = fileTimes, aes(x = iteration, y = time_diff), stat = "identity") +
  labs(x = "Iteration", y = "Runtime [minutes]") +
  ggtitle("Runtime for PyPSA-EUR") + 
  ylim(0, NA)

print(pTimeDiff)
    
```

# Coupled variables

This section includes plots of all variables that are exchanged between REMIND
and PyPSA-Eur.

## REMIND to PyPSA-Eur

This section includes variables that are transferred from REMIND to PyPSA-Eur (displayed as lines).
Values used by PyPSA-EUR are also retrieved to cross-check (displayed as points).

### Electricity load

```{r load}

# Read REMIND data
dataLoadREMIND <- readREMINDgdx(
  paths = rm2pyFiles,
  gdxVar = "v32_usableSeDisp",
  columns = c("ttot" = "year", "all_regi" = "region", "all_enty" = "technology", "value" = "value"),
  colFilter = list("year" = years, "region" = regions, "technology" = "seel"),
  restoreZeros = FALSE,
  recalcUnit = twa2twh)

# Load PyPSAEUR electricity loads for cross-checking
dataLoadPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "electricity_loads.csv")) %>% 
  mutate(value = value / 1e6)  # Convert MWh to TWh

# Plot by year
pYear <- ggplot() +
  geom_line(data = dataLoadREMIND, aes(x = year, y = value, color = region)) +
  geom_point(data = dataLoadPyPSA, aes(x = year, y = value, color = region)) +
  labs(x = "Year", y = "Electricity load (TWh)") +
  ggtitle("Electricity load by year") +
  facet_wrap(~ iteration)

# Plot by iteration
pIter <- ggplot() +
  geom_line(data = dataLoadREMIND, aes(x = iteration, y = value, color = region)) +
  geom_point(data = dataLoadPyPSA, aes(x = iteration, y = value, color = region)) +
  labs(x = "Iteration", y = "Electricity load (TWh)") +
  ggtitle("Electricity load by iteration") +
  facet_wrap(~ year)

print(pYear)

print(pIter)

```

### Pre-investment capacities

```{r pre-investment capacities, echo = FALSE, message = FALSE}
# Deactivate for now
if (FALSE){
# Read REMIND data
dataPreInvestREMIND <- readREMINDgdx(
  paths = rm2pyFiles,
  gdxVar = "p32_preInvCap",
  columns = c("ttot" = "year", "all_regi" = "region", "all_te" = "technology", "value" = "value"),
  colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech)),
  restoreZeros = TRUE,
  recalcUnit = 1e3)  # TW to GW

# Read PyPSA-Eur data
dataPreInvestPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "preinstalled_capacities.csv")) %>% 
  mutate(value = value / 1e3)  # Convert capacities to GW

# Plot by year
pYear <- ggplot() +
  geom_line(data = dataPreInvestREMIND, aes(x = year, y = value, color = technology)) +
  geom_point(data = dataPreInvestPyPSA, aes(x = year, y = value, color = carrier)) +
  labs(x = "Year", y = "Capacity (GW)") +
  ggtitle("Pre-investment capacity by year") +
  facet_wrap(~ iteration, scales = "free")

# Plot by iteration
pIter <- ggplot() +
  geom_line(data = dataPreInvestREMIND, aes(x = iteration, y = value, color = technology)) +
  geom_point(data = dataPreInvestPyPSA, aes(x = iteration, y = value, color = carrier)) +
  labs(x = "Iteration", y = "Capacity (GW)") +
  ggtitle("Pre-investment capacity by iteration") +
  facet_wrap(~ year, scales = "free")

print(pYear)

print(pIter)
}
```

### Specific capital costs (investment costs)
```{r specific capital costs}

# Loop over iteration directories and years to read costs.csv files
# for each (iteration, year) combination
costs_list <- list()
for (i in seq_along(pyResourcesDirs)) {
  # Get subdirectories labeled "y" for year followed by a year number
  pyYearDirs <- list.dirs(pyResourcesDirs[i],
                           recursive = FALSE,
                           full.names = TRUE)
  # Loop over year directories to read costs.csv files
  for (j in seq_along(pyYearDirs)) {
    # Get path to costs.csv file
    costs_file <- file.path(pyYearDirs[j], "costs.csv")
    # Read costs.csv file into data frame
    costs_df <- read.csv(costs_file)
    # Add iteration and year columns to data frame
    iteration <- gsub("i", "", basename(pyResourcesDirs[i]))
    year <- gsub("y", "", basename(pyYearDirs[j]))
    costs_df$iteration <- iteration
    costs_df$year <- year
    # Add data frame to list
    costs_list[[length(costs_list) + 1]] <- costs_df
  }
}

# Combine the data frames into a single data frame.
costs_df <- do.call(rbind, costs_list)
# Only select cost data coming from REMIND-EU
costs_df <- subset(costs_df, source == "REMIND-EU")
costs_df$technology <- str_replace_all(costs_df$technology, "-", " ")

# Plot investment costs for all technologies with different markers for each year and iterations offset along the y-axis
# Only investment costs
label <- "Investment Costs"
plot_data <- subset(costs_df, parameter == "investment")
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Fixed O&M costs
```{r fixed o&m costs}

plot_data <- subset(costs_df, parameter == "FOM")
label <- "Fixed O&M Costs"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Lifetimes
```{r lifetimes}
plot_data <- subset(costs_df, parameter == "lifetime")
label <- "Lifetime"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Discount rates
```{r discount rates}
plot_data <- subset(costs_df, parameter == "discount_rate")
label <- "Discount Rate"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Variable O&M costs
```{r variable o&m costs}
plot_data <- subset(costs_df, parameter == "VOM")
label <- "Variable O&M Costs"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Fuel costs
```{r fuel costs}
plot_data <- subset(costs_df, parameter == "fuel")
label <- "Fuel Costs"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### Efficiencies
```{r efficiencies}
plot_data <- subset(costs_df, parameter == "efficiency")
label <- "Efficiency"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### CO2 intensity
```{r co2 intensity}
plot_data <- subset(costs_df, parameter == "CO2 intensity")
label <- "CO2 intensity"
ggplot(plot_data, aes(x = value, y = technology, group = factor(desc(iteration)), shape = factor(iteration), color = year)) +
    geom_point(position = position_dodge(width = 0.3)) +
    labs(y = "technology", x = paste0(label," [", unique(plot_data$unit), "]")) +
    scale_color_discrete(name = "Year") + 
    scale_shape_discrete(name = "Iteration") +
    scale_y_discrete(labels = function(y) str_wrap(y, width = 15), limits = rev) +
    ggtitle(label)
```

### CO2 prices
```{r co2 price}

# REMIND data
dataCO2PriceREMIND <- readREMINDgdx(
  paths = rm2pyFiles,
  gdxVar = "p_priceCO2",
  columns = c("tall" = "year", "all_regi" = "region", "value" = "value"),
  colFilter = list("year" = years, "region" = regions),
  restoreZeros = TRUE,
  recalcUnit = tC2tCO2
)

# PyPSA data
dataCO2PricePyPSA <- readPyPSAcsv(
    paths = file.path(pyResultsDirs, "co2_price_scenarios.csv")) %>% 
  # Extract the CO2 price from the opts columns which starts with Ep followed by a number of format 0.0
  mutate(value = as.numeric(str_extract(opts, "(?<=Ep)\\d+\\.\\d{1,2}")))

# Plot by year
pYear <- ggplot() +
  geom_line(data = dataCO2PriceREMIND, aes(x = year, y = value)) +
  geom_point(data = dataCO2PricePyPSA, aes(x = year, y = value)) +
  labs(x = "Year", y = "CO2 price (EUR/tCO2)") +
  ggtitle("CO2 price by year") +
  facet_wrap(~ iteration)

# Plot by iteration
pIter <- ggplot() +
  geom_line(data = dataCO2PriceREMIND, aes(x = iteration, y = value)) +
  geom_point(data = dataCO2PricePyPSA, aes(x = iteration, y = value)) +
  labs(x = "Iteration", y = "CO2 price (EUR/tCO2)") +
  ggtitle("CO2 price by iteration") +
  facet_wrap(~ year)

print(pYear)

print(pIter)

```

## PyPSA-Eur to REMIND

This section includes variables that are transferred from PyPSA-Eur to REMIND (displayed as points).
Values used by REMIND are also retrieved to cross-check (displayed as lines).

### Capacity factors

```{r capacity factors}

# REMIND capacity factors
# Capacity factors are handled differently for dispatchable and VRE technologies

# Read vm_capFac (for dispatchable technologies)
vmCapFac <- readREMINDgdx(
  paths = rmFulldataFiles,
  gdxVar = "vm_capFac",
  columns = c("ttot" = "year", "all_regi" = "region", "all_te" = "technology", "value" = "vmCapFac"),
  colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech)),
  restoreZeros = FALSE)

# Read vm_capDistr (for VRE technologies)
vmCapDistr <- readREMINDgdx(
  paths = rmFulldataFiles,
  gdxVar = "vm_capDistr",
  columns = c("tall" = "year", "all_regi" = "region", "all_te" = "technology", "rlf" = "rlf", "value" = "vmCapDistr"),
  colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech)),
  restoreZeros = FALSE)

# Read pm_dataren (for VRE technologies)
pmDataren <- readREMINDgdx(
  paths = rmFulldataFiles,
  gdxVar = "pm_dataren",
  columns = c("all_regi" = "region", "all_te" = "technology", "char" = "char", "rlf" = "rlf", "value" = "pmDataren"),
  colFilter = list("region" = "DEU", "char" = "nur", "technology" = names(rm2genTech)),
  restoreZeros = FALSE)

# Read teReNoBio set (for VRE technologies)
teReNoBio <- gdx::readGDX(rmFulldataFiles[1], "teReNoBio", restore_zeros = FALSE)

# Calculate capacity factor for VRE technologies
capfacRlf <- vmCapFac %>%
  filter(.data$technology %in% teReNoBio) %>%
  full_join(vmCapDistr %>%
              filter(.data$technology %in% teReNoBio)) %>%
  full_join(pmDataren %>%
              filter(.data$technology %in% teReNoBio)) %>%
  # Filter away rlfs that are not used
  filter(!is.na(pmDataren)) %>%
  group_by(.data$year, .data$region, .data$technology, .data$iteration) %>%
  summarise(capfac = sum(vmCapFac * vmCapDistr * pmDataren) / sum(vmCapDistr))

# Capacity factor for non-rlf technologies
capfacNoRlf <- vmCapFac %>%
  filter(!(.data$technology %in% teReNoBio)) %>%
  group_by(.data$year, .data$region, .data$technology, .data$iteration) %>%
  dplyr::transmute(capfac = vmCapFac)

# Combine capacity factors for all technologies
dataCapfacREMIND <- bind_rows(capfacRlf, capfacNoRlf) %>%
  quitte::revalue.levels(technology = rm2genTech) %>%
  group_by(.data$year, .data$region, .data$technology, .data$iteration) %>%
  mutate(dummy = ifelse(iteration > 1,
                        as.integer(dplyr::n_distinct(.data$capfac) == 1),
                        1))

# Throw warning if some capacity factors don't match within group
if (any(dataCapfacREMIND$dummy == 0)) {
  techProb <- as.character(unique(remind$technology[remind$dummy == 0]))
  warning(paste("Capacity factors for", techProb, "don't match.\n"))
  }

# REMIND data for plotting
dataCapfacREMINDplot <- dataCapfacREMIND %>%
  # Take the average of all general technologies
  # Values should be the same as they come from PyPSA-Eur
  # However, in iterations before PyPSA starts, they are not the same
  summarise(capfac = mean(.data$capfac)) %>%
  quitte::order.levels(technology = names(colorsTech)) %>%
  rename(value = capfac)

# PyPSA-Eur capacity factors
dataCapfacPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "capacity_factors.csv")) %>%
  # Increment iteration by 1 to match REMIND
  mutate(iteration = iteration + 1) %>%
  quitte::revalue.levels(carrier = rm2genTech) %>%
  group_by(.data$year, .data$region, .data$carrier, .data$iteration) %>%
  summarise(value = unique(.data$value))

# Plot by year
pCapfacYear <- ggplot() +
  # Layer 1: REMIND
  geom_line(data = dataCapfacREMINDplot, aes(x = year, y = value, color = technology)) +
  # Layer 2: PyPSA-Eur
  geom_point(data = dataCapfacPyPSA, aes(x = year, y = value, color = carrier)) +
  # Legend formatting
  scale_color_manual(
    name = "Technology",
    values = colorsTech,
    labels = namesTech,
  ) +
  labs(x = "Year", y = "Capacity factor") +
  ggtitle("Capacity factor, iterations in panels") +
  facet_wrap(~ iteration)

# Plot by iteration
pCapfacIter <- ggplot() +
  # Layer 1: REMIND
  geom_line(data = dataCapfacREMINDplot, aes(x = iteration, y = value, color = technology)) +
  # Layer 2: PyPSA-Eur
  geom_point(data = dataCapfacPyPSA, aes(x = iteration, y = value, color = carrier)) +
  # Legend formatting
  scale_color_manual(
    name = "Technology",
    values = colorsTech,
    labels = namesTech,
  ) +
  labs(x = "Iteration", y = "Capacity factor") +
  ggtitle("Capacity factor, years in panels") +
  facet_wrap(~ year)

print(pCapfacYear)

print(pCapfacIter)

```

### Market values

Work in progress...

```{r market values}

# REMIND data
#dataMarketValueREMIND <- ...

dataMarketValuePyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "market_values.csv")) %>% 
  # Increment iteration by 1 to match REMIND
  mutate(iteration = iteration + 1) %>% 
  quitte::revalue.levels(carrier = rm2genTech) %>%
  group_by(.data$year, .data$region, .data$carrier, .data$iteration) %>%
  summarise(value = unique(.data$value)) %>% 
  quitte::order.levels(carrier = names(namesTech))

pMarketValueYear <- ggplot() +
  # Layer 1: REMIND
  #geom_line(data = dataMarketValueREMIND, aes(x = year, y = value, color = technology)) +
  # Layer 2: PyPSA-Eur
  geom_point(data = dataMarketValuePyPSA, aes(x = year, y = value, color = carrier)) +
  scale_color_manual(
    name = "Technology",
    values = colorsTech,
    labels = namesTech,
  ) +
  labs(x = "Year", y = "Market value ($/MWh)") +
  ggtitle("Market values by year") +
  facet_wrap(~ iteration)

pMarketValueIter <- ggplot() +
  # Layer 1: REMIND
  #geom_line(data = dataMarketValueREMIND, aes(x = iteration, y = value, color = technology)) +
  # Layer 2: PyPSA-Eur
  geom_point(data = dataMarketValuePyPSA, aes(x = iteration, y = value, color = carrier)) +
  scale_color_manual(
    name = "Technology",
    values = colorsTech,
    labels = namesTech,
  ) +
  labs(x = "Iteration", y = "Market value ($/MWh)") +
  ggtitle("Market values by iteration") +
  facet_wrap(~ year)

print(pMarketValueYear)

print(pMarketValueIter)

```

## Markups / Markdowns

Markups and markdowns are read into REMIND from PYPSA-Eur.

Markup = Average market value - Average electricity price

# Non-coupled variables

This section includes plots of several key variables that are not coupled
between REMIND and PyPSA-Eur, but that should get harmonised.

## Capacities

```{r capacity investment}

# Read REMIND data
dataPreInvCapREMIND <- readREMINDgdx(
    paths = rmFulldataFiles,
    gdxVar = "p32_preInvCap",
    columns = c("ttot" = "year", "all_regi" = "region", "all_te" = "technology", "value" = "p32_preInvCap"),
    colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech)),
    restoreZeros = TRUE,
    recalcUnit = 1e3) %>%   # TW to GW
  revalue.levels(technology = rm2genTech) %>%
  group_by(year, region, technology, iteration) %>%
  summarise(preInvCap = sum(p32_preInvCap))

dataCapREMIND <- readREMINDgdx(
    paths = rmFulldataFiles,
    gdxVar = "vm_cap",
    columns = c("tall" = "year", "all_regi" = "region", "all_te" = "technology", "rlf" = "grade", "value" = "vm_cap"),
    colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech), "grade" = 1),
    restoreZeros = FALSE,
    recalcUnit = 1e3) %>%   # TW to GW
  select(-grade) %>%   # Remove grade column
  revalue.levels(technology = rm2genTech) %>%
  group_by(year, region, technology, iteration) %>%
  summarise(cap = sum(vm_cap))

dataCapInvestREMIND <- full_join(dataPreInvCapREMIND, dataCapREMIND) %>%
  mutate(deltaCap = cap - preInvCap) %>%
  order.levels(technology = names(colorsTech))

# Read PyPSA-Eur data
dataPreInvCapPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "preinstalled_capacities.csv")) %>%
  mutate(value = value / 1e3) %>%   # Convert capacities to GW
  rename(preInvCap = value) %>%
  revalue.levels(carrier = pygen2genTech)

dataCapPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "optimal_capacities.csv")) %>%
  filter(type == "Generator",
         carrier != "Load shedding") %>%
  mutate(value = value / 1e3) %>%   # Convert capacities to GW
  select(-type) %>%
  rename(cap = value) %>%
  revalue.levels(carrier = pygen2genTech)

dataCapInvestPyPSA <- full_join(dataPreInvCapPyPSA, dataCapPyPSA) %>%
  # TODO! Fill NA values with 0
  mutate(preInvCap = ifelse(is.na(preInvCap), 0, preInvCap),
         cap = ifelse(is.na(cap), 0, cap)) %>%
  mutate(deltaCap = cap - preInvCap) %>%
  rename(technology = carrier) %>%
  order.levels(technology = names(colorsTech))

# Throw warning if any deltaCap in dataCapInvestPyPSA is negative and say for which carrier
if (any(dataCapInvestPyPSA$deltaCap < 0)) {
  warning("Negative deltaCap in dataCapInvestPyPSA for the following carriers:")
  warning(dataCapInvestPyPSA %>% ungroup() %>% filter(deltaCap < 0) %>% pull(technology) %>% unique())
}

for (i in rmIterations){
  dataCapInvestREMINDiStack <- dataCapInvestREMIND %>%
    filter(iteration == i) %>%
    pivot_longer(cols = c("deltaCap", "preInvCap"),
                names_to = "variable",
                values_to = "value")

  dataCapInvestPyPSAiStack <- dataCapInvestPyPSA %>%
    filter(iteration == i) %>%
    pivot_longer(cols = c("deltaCap", "preInvCap"),
                names_to = "variable",
                values_to = "value")

  # Create plot
  pCapInvest <- ggplot() +
    geom_bar(data = dataCapInvestREMINDiStack,
            mapping = aes(x = year, y = value, alpha = variable, fill = technology, linetype = "REMIND"),
            stat = "identity",
            position = position_stacknudge(x = -1.2),
            color = "black",
            linewidth = 0.25,
            width = 2) +
    geom_bar(data = dataCapInvestPyPSAiStack,
            mapping = aes(x = year, y = value, alpha = variable, fill = technology, linetype = "PyPSA-Eur"),
            stat = "identity",
            position = position_stacknudge(x = 1.2),
            color = "black",
            linewidth = 0.25,
            width = 2) +
    scale_alpha_manual(
      name = "Capacity",
      values = c("deltaCap" = 0.5, "preInvCap" = 1),
      labels = c("deltaCap" = "Investment",
                "preInvCap" = "Pre-investment")) +
    scale_fill_manual(
      name = "Technology",
      values = colorsTech,
      labels = namesTech) +
    scale_linetype_manual(
      name = "Model",
      values = c("REMIND" = "solid",
                "PyPSA-Eur" = "dashed")) +
    guides(linetype = guide_legend(override.aes = list(fill = NA)),
           fill = "none") +
    labs(x = "Year", y = "Capacity (GW)") +
    ggtitle(paste("Capacity investment over years, model comparison, iteration", i)) +
    facet_wrap(~ technology, ncol = 3, scales = "free", labeller = labeller(technology = namesTech))

  print(pCapInvest)
}
```

```{r capacity comparison}

# REMIND
dataCapREMIND <- readREMINDgdx(
  paths = rmFulldataFiles,
  gdxVar = "vm_cap",
  columns = c("tall" = "year", "all_regi" = "region", "all_te" = "technology", "rlf" = "grade", "value" = "value"),
  colFilter = list("year" = years, "region" = regions, "technology" = names(rm2genTech), "grade" = 1),
  restoreZeros = FALSE,
  recalcUnit = 1e3)  # TW to GW

dataCapREMINDplot <- dataCapREMIND %>%
  revalue.levels(technology = rm2genTech) %>%
  group_by(.data$year, .data$region, .data$technology, .data$iteration) %>%
  summarise(value = sum(.data$value)) %>%
  order.levels(technology = names(colorsTech))

# Read optimal capacities from the CSV files
dataCapPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "optimal_capacities.csv")) %>%
  mutate(value = value / 1e3) %>%  # Convert capacities to GW
  filter(!is.na(value),
         value > 0.1,
         carrier != "Load shedding")

dataCapPyPSAplot <- dataCapPyPSA %>%
  filter(type == "Generator") %>%
  revalue.levels(carrier = pygen2genTech) %>%
  group_by(.data$year, .data$carrier, .data$iteration) %>%
  summarise(value = sum(.data$value)) %>%
  mutate(technology = as.factor(carrier)) %>%
  order.levels(technology = names(colorsTech))

# Loop over iterations
for (i in rmIterations){

  dataCapREMINDploti <- dataCapREMINDplot %>%
    ungroup() %>%
    filter(iteration == i)

  dataCapREMINDplotitot <- dataCapREMINDploti %>%
    group_by(year) %>%
    summarise(value = sum(value))

  dataCapPyPSAploti <- dataCapPyPSAplot %>%
    ungroup() %>%
    filter(iteration == i)

  dataCapPyPSAplotitot <- dataCapPyPSAploti %>%
    group_by(year) %>%
    summarise(value = sum(value))

  pCapComp <- ggplot() +
    geom_bar(data = dataCapREMINDploti,
            mapping = aes(x = year, y = value, fill = technology),
            stat = "identity",
            position = position_stacknudge(x = -1.2),
            width = 2) +
    geom_bar(data = dataCapREMINDplotitot,
            mapping = aes(x = year, y = value, linetype = "REMIND"),
            stat = "identity",
            position = position_nudge(x = -1.2),
            width = 2,
            linewidth = 0.25,
            color = "black",
            fill = NA) +
    geom_bar(data = dataCapPyPSAploti,
            mapping = aes(x = year, y = value, fill = technology),
            stat = "identity",
            position = position_stacknudge(x = 1.2),
            width = 2) +
    geom_bar(data = dataCapPyPSAplotitot,
            mapping = aes(x = year, y = value, linetype = "PyPSA-Eur"),
            stat = "identity",
            position = position_nudge(x = 1.2),
            width = 2,
            linewidth = 0.25,
            color = "black",
            fill = NA) +
    scale_fill_manual(
      name = "Technology",
      values = colorsTech,
      labels = namesTech,
    ) +
    scale_linetype_manual(
      name = "Model",
      values = c("REMIND" = "solid", "PyPSA-Eur" = "dashed"),
    ) +
    scale_x_continuous(breaks = years) +
    labs(x = "Year", y = "Capacity (GW)") +
    ggtitle(paste("Capacity over years, model comparison, iteration", i))

  print(pCapComp)
}

```

## Generation

```{r generation comparison}

# REMIND
dataGenREMIND <- readREMINDgdx(
    paths = rmFulldataFiles,
    gdxVar = "vm_prodSe",
    columns = c("tall" = "year", "all_regi" = "region", "all_enty1" = "secarrier", "all_te" = "technology", "value" = "vm_prodSe"),
    colFilter = list("year" = years, "region" = regions, "secarrier" = "seel", "technology" = names(rm2genTech)),
    restoreZeros = FALSE,
    recalcUnit = twa2twh) %>%  # TWa to TWh
  select(-secarrier) %>%
  revalue.levels(technology = rm2genTech) %>%
  group_by(.data$year, .data$region, .data$technology, .data$iteration) %>%
  summarise(vm_prodSe = sum(.data$vm_prodSe)) %>%
  order.levels(technology = names(colorsTech))

# PyPSA-Eur
dataGenPyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "generations.csv")) %>%
  mutate(value = value / 1e6) %>%  # MWh to TWh
  revalue.levels(carrier = pygen2genTech) %>%
  mutate(technology = as.factor(carrier)) %>%
  order.levels(technology = names(colorsTech))

# Loop over iterations
for (i in rmIterations){

  dataGenREMINDploti <- dataGenREMIND %>%
    ungroup() %>%
    filter(iteration == i)

  dataGenREMINDplotitot <- dataGenREMINDploti %>%
    group_by(year) %>%
    summarise(vm_prodSe = sum(vm_prodSe))

  dataGenPyPSAploti <- dataGenPyPSA %>%
    ungroup() %>%
    filter(iteration == i)

  dataGenPyPSAplotitot <- dataGenPyPSAploti %>%
    group_by(year) %>%
    summarise(value = sum(value))

  pGenComp <- ggplot() +
    geom_bar(data = dataGenREMINDploti,
            mapping = aes(x = year, y = vm_prodSe, fill = technology),
            stat = "identity",
            position = position_stacknudge(x = -1.2),
            width = 2) +
    geom_bar(data = dataGenREMINDplotitot,
            mapping = aes(x = year, y = vm_prodSe, linetype = "REMIND"),
            stat = "identity",
            position = position_nudge(x = -1.2),
            width = 2,
            linewidth = 0.25,
            color = "black",
            fill = NA) +
    geom_bar(data = dataGenPyPSAploti,
            mapping = aes(x = year, y = value, fill = technology),
            stat = "identity",
            position = position_stacknudge(x = 1.2),
            width = 2) +
    geom_bar(data = dataGenPyPSAplotitot,
            mapping = aes(x = year, y = value, linetype = "PyPSA-Eur"),
            stat = "identity",
            position = position_nudge(x = 1.2),
            width = 2,
            linewidth = 0.25,
            color = "black",
            fill = NA) +
    scale_fill_manual(
      name = "Technology",
      values = colorsTech,
      labels = namesTech,
    ) +
    scale_linetype_manual(
      name = "Model",
      values = c("REMIND" = "solid", "PyPSA-Eur" = "dashed"),
    ) +
    scale_x_continuous(breaks = years) +
    labs(x = "Year", y = "Generation (TWh)") +
    ggtitle(paste("Generation over years, model comparison, iteration", i))

  print(pGenComp)
}

```

## Electricity price

```{r electricity price over years}

# REMIND
dataElecPriceREMIND <- readREMINDgdx(
    paths = rmFulldataFiles,
    gdxVar = "pm_SEPrice",
    columns = c("ttot" = "year", "all_regi" = "region", "all_enty" = "secarrier", "value" = "pm_SEPrice"),
    colFilter = list("year" = years, "region" = regions, "secarrier" = "seel"),
    restoreZeros = FALSE,
    recalcUnit = 1E12 / twa2mwh) %>%  # T$/TWa to $/MWh
  select(-secarrier)

# PyPSA-Eur
dataElecPricePyPSA <- readPyPSAcsv(
  paths = file.path(pyValidationDirs, "electricity_prices.csv"))


pElecPriceYear <- ggplot() +
  geom_line(data = dataElecPriceREMIND,
            mapping = aes(x = year, y = pm_SEPrice, color = "REMIND")) +
  geom_line(data = dataElecPricePyPSA,
            mapping = aes(x = year, y = value, color = "PyPSA-Eur")) +
  scale_color_discrete(name = "Model") +
  labs(x = "Year", y = "Electricity price ($/MWh)") +
  ggtitle("Electricity price over years, model comparison") +
  facet_wrap(~ iteration)

print(pElecPriceYear)

pElecPriceIter <- ggplot() +
  geom_line(data = dataElecPriceREMIND,
            mapping = aes(x = iteration, y = pm_SEPrice, color = "REMIND")) +
  geom_line(data = dataElecPricePyPSA,
            mapping = aes(x = iteration, y = value, color = "PyPSA-Eur")) +
  scale_color_discrete(name = "Model") +
  labs(x = "Iteration", y = "Electricity price ($/MWh)") +
  ggtitle("Electricity price over iterations, model comparison") +
  facet_wrap(~ year)

print(pElecPriceIter)

```

# Model-specific variables

## REMIND

## PyPSA-Eur

### Screening curves

### Inverse screening curves

### Residual load duration curves (RLDCs)

